%!

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Set variables that change with each circular plot.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Set font size and type.
/fontSize 24 def
/quarterFont fontSize 4 div def
/halfFont fontSize 2 div def
/Courier findfont fontSize scalefont setfont

% Set variables handling number, placement of nucleotides.
/numBases 412 def
/currentBase 0 def
/basePoints numBases array def

% Set variables handling scaling, translation of circular backbone.
/scaleFactor 0.195238 def
/scaleFactorX scaleFactor def
/scaleFactorY scaleFactor def
/translateFactorX 0 def
/translateFactorY 0 def

% Set variables handling properties of circular backbone.
/radius 1260 def
/center 306 scaleFactor div def
/angle 360 numBases 2 add div -1 mul def
/labelSpace 20 def

% Create the array of nucleotides.
/bases [
    (G) (U) (G) (U) (G) (C) (C) (C) (G) (G) (C) (A) (U) (G) (G) (G) (U) (G) (C) (A) (G) (U) (C) (U) (A) (U) (A) (G) (G) (G) (U) (G) (A) (G) (A) (G) (U) (C) (C) (C) (G) (A) (A) (C) (U) (G) (U) (G) (A) (A) (G) (G) (C) (A) (G) (A) (A) (G) (U) (A) (A) (C) (A) (G) (U) (U) (A) (G) (C) (C) (U) (A) (A) (C) (G) (C) (A) (A) (G) (G) (G) (U) (G) (U) (C) (C) (G) (U) (G) (G) (C) (G) (A) (C) (A) (U) (G) (G) (A) (A) (U) (C) (U) (G) (A) (A) (G) (G) (A) (A) (G) (C) (G) (G) (A) (C) (G) (G) (C) (A) (A) (A) (C) (C) (U) (U) (C) (G) (G) (U) (C) (U) (G) (A) (G) (G) (A) (A) (C) (A) (C) (G) (A) (A) (C) (U) (U) (C) (A) (U) (A) (U) (G) (A) (G) (G) (C) (U) (A) (G) (G) (U) (A) (U) (C) (A) (A) (U) (G) (G) (A) (U) (G) (A) (G) (U) (U) (U) (G) (C) (A) (U) (A) (A) (C) (A) (A) (A) (A) (C) (A) (A) (A) (G) (U) (C) (C) (U) (U) (U) (C) (U) (G) (C) (C) (A) (A) (A) (G) (U) (U) (G) (G) (U) (A) (C) (A) (G) (A) (G) (U) (A) (A) (A) (U) (G) (A) (A) (G) (C) (A) (G) (A) (U) (U) (G) (A) (U) (G) (A) (A) (G) (G) (G) (A) (A) (A) (G) (A) (C) (U) (G) (C) (A) (U) (U) (C) (U) (U) (A) (C) (C) (C) (G) (G) (G) (G) (A) (G) (G) (U) (C) (U) (G) (G) (A) (A) (A) (C) (A) (G) (A) (A) (G) (U) (C) (A) (G) (C) (A) (G) (A) (A) (G) (U) (C) (A) (U) (A) (G) (U) (A) (C) (C) (C) (U) (G) (U) (U) (C) (G) (C) (A) (G) (G) (G) (G) (A) (A) (G) (G) (A) (C) (G) (G) (A) (A) (C) (A) (A) (G) (U) (A) (U) (G) (G) (C) (G) (U) (U) (C) (G) (C) (G) (C) (C) (U) (A) (A) (G) (C) (U) (U) (G) (A) (A) (C) (C) (G) (C) (C) (G) (U) (A) (U) (A) (C) (C) (G) (A) (A) (C) (G) (G) (U) (A) (C) (G) (U) (A) (C) (G) (G) (U) (G) (G) (U) (G) (U) (G) (A) (G) (A) (G) (G) (A) (G) (U) (U) (C) (G) (C) (U) (C) (U) (A) (C) (U) (C) (U) (A) (U) 
] def

% Write the array of pairings.
/pairings [
    [6 266 0.00 0.50 0.00]
    [7 265 0.00 0.50 0.00]
    [8 264 0.00 0.50 0.00]
    [9 263 0.00 0.50 0.00]
    [10 262 0.00 0.50 0.00]
    [12 259 0.00 0.50 0.00]
    [14 257 0.00 0.50 0.00]
    [15 256 0.00 0.50 0.00]
    [16 255 0.00 0.50 0.00]
    [17 254 0.00 0.50 0.00]
    [18 253 0.00 0.50 0.00]
    [19 252 0.00 0.50 0.00]
    [20 251 0.00 0.50 0.00]
    [21 250 0.00 0.50 0.00]
    [22 249 0.00 0.50 0.00]
    [23 248 0.00 0.50 0.00]
    [24 247 0.00 0.50 0.00]
    [26 42 0.00 0.50 0.00]
    [28 40 0.00 0.50 0.00]
    [29 39 0.00 0.50 0.00]
    [30 38 0.00 0.50 0.00]
    [31 35 0.00 0.50 0.00]
    [43 65 0.00 0.50 0.00]
    [44 64 0.00 0.50 0.00]
    [45 63 0.00 0.50 0.00]
    [46 62 0.00 0.50 0.00]
    [47 61 0.00 0.50 0.00]
    [49 59 0.00 0.50 0.00]
    [51 205 0.00 0.50 0.00]
    [52 204 0.00 0.50 0.00]
    [53 203 0.00 0.50 0.00]
    [54 202 0.00 0.50 0.00]
    [55 201 0.00 0.50 0.00]
    [56 200 0.00 0.50 0.00]
    [57 199 0.00 0.50 0.00]
    [66 121 0.00 0.50 0.00]
    [68 119 0.00 0.50 0.00]
    [69 118 0.00 0.50 0.00]
    [70 117 0.00 0.50 0.00]
    [74 113 0.00 0.50 0.00]
    [75 112 0.00 0.50 0.00]
    [76 111 0.00 0.50 0.00]
    [79 103 0.00 0.50 0.00]
    [80 102 0.00 0.50 0.00]
    [81 101 0.00 0.50 0.00]
    [82 100 0.00 0.50 0.00]
    [84 99 0.00 0.50 0.00]
    [85 98 0.00 0.50 0.00]
    [86 97 0.00 0.50 0.00]
    [87 96 0.00 0.50 0.00]
    [88 95 0.00 0.50 0.00]
    [89 94 0.00 0.50 0.00]
    [123 243 0.00 0.50 0.00]
    [124 242 0.00 0.50 0.00]
    [125 241 0.00 0.50 0.00]
    [126 240 0.00 0.50 0.00]
    [127 239 0.00 0.50 0.00]
    [128 235 0.00 0.50 0.00]
    [129 234 0.00 0.50 0.00]
    [130 233 0.00 0.50 0.00]
    [131 232 0.00 0.50 0.00]
    [132 231 0.00 0.50 0.00]
    [133 230 0.00 0.50 0.00]
    [135 141 0.00 0.50 0.00]
    [145 229 0.00 0.50 0.00]
    [146 228 0.00 0.50 0.00]
    [147 227 0.00 0.50 0.00]
    [148 226 0.00 0.50 0.00]
    [149 225 0.00 0.50 0.00]
    [150 224 0.00 0.50 0.00]
    [156 221 0.00 0.50 0.00]
    [157 220 0.00 0.50 0.00]
    [158 219 0.00 0.50 0.00]
    [161 216 0.00 0.50 0.00]
    [162 215 0.00 0.50 0.00]
    [163 214 0.00 0.50 0.00]
    [164 213 0.00 0.50 0.00]
    [165 212 0.00 0.50 0.00]
    [166 211 0.00 0.50 0.00]
    [167 210 0.00 0.50 0.00]
    [168 209 0.00 0.50 0.00]
    [169 197 0.00 0.50 0.00]
    [170 196 0.00 0.50 0.00]
    [171 195 0.00 0.50 0.00]
    [172 194 0.00 0.50 0.00]
    [175 190 0.00 0.50 0.00]
    [176 189 0.00 0.50 0.00]
    [177 188 0.00 0.50 0.00]
    [178 187 0.00 0.50 0.00]
    [267 286 0.00 0.50 0.00]
    [268 285 0.00 0.50 0.00]
    [271 282 0.00 0.50 0.00]
    [272 281 0.00 0.50 0.00]
    [273 280 0.00 0.50 0.00]
    [274 279 0.00 0.50 0.00]
    [294 323 0.00 0.50 0.00]
    [295 322 0.00 0.50 0.00]
    [296 321 0.00 0.50 0.00]
    [303 316 0.00 0.50 0.00]
    [304 315 0.00 0.50 0.00]
    [305 314 0.00 0.50 0.00]
    [306 313 0.00 0.50 0.00]
    [307 312 0.00 0.50 0.00]
    [328 354 0.00 0.50 0.00]
    [329 353 0.00 0.50 0.00]
    [330 352 0.00 0.50 0.00]
    [331 351 0.00 0.50 0.00]
    [332 350 0.00 0.50 0.00]
    [333 347 0.00 0.50 0.00]
    [335 346 0.00 0.50 0.00]
    [336 345 0.00 0.50 0.00]
    [337 344 0.00 0.50 0.00]
    [338 343 0.00 0.50 0.00]
    [356 387 0.00 0.50 0.00]
    [357 386 0.00 0.50 0.00]
    [358 385 0.00 0.50 0.00]
    [359 384 0.00 0.50 0.00]
    [360 383 0.00 0.50 0.00]
    [361 382 0.00 0.50 0.00]
    [362 381 0.00 0.50 0.00]
    [363 380 0.00 0.50 0.00]
    [364 379 0.00 0.50 0.00]
    [365 376 0.00 0.50 0.00]
    [366 375 0.00 0.50 0.00]
    [367 374 0.00 0.50 0.00]
    [368 373 0.00 0.50 0.00]
    [390 409 0.00 0.50 0.00]
    [391 408 0.00 0.50 0.00]
    [392 407 0.00 0.50 0.00]
    [394 405 0.00 0.50 0.00]
    [395 404 0.00 0.50 0.00]
    [396 403 0.00 0.50 0.00]
    [397 402 0.00 0.50 0.00]
] def

% Set variables handling number, placement of pairings.
/numPairings 133 def
/numPseudoknotted 0 def
/currentPairing 0 def

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Write out the combined circular structure.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Set the font size and type for the descriptor.
/Courier-Bold findfont fontSize 2 div scalefont setfont

/numDescriptors 7 def
/descriptors [
    [(Predicted Structure file name: G2intron.correct.ct) 0.00 0.00 0.00 40 740]
    [(Accepted Structure file name:  G2intron.correct.ct) 0.00 0.00 0.00 40 725]
    [(Predicted Structure: ENERGY = -383.2  GRII) 0.00 0.00 0.00 40 695]
    [(Accepted Structure:  ENERGY = -383.2  GRII) 0.00 0.00 0.00 40 680]
    [(Green:  Pair in both structures) 0.00 0.50 0.00 40 650]
    [(Red:    Pair in Accepted Structure only) 1.00 0.00 0.00 40 635]
    [(Purple: Pair in Predicted Structure only) 0.40 0.00 0.60 40 620]
] def

% Write the contents of the descriptor array.
descriptors { aload pop moveto setrgbcolor show } forall

% Reset the font to its original size, type, and color.
/Courier findfont fontSize scalefont setfont
0 setgray

% Write the translation and scaling of the main image.
gsave
scaleFactorX scaleFactorY scale
translateFactorX translateFactorY translate

% Use repeat loop to write nucleotides on the circular path.
0 1 numBases {
    clear

    % Move to appropriate point, angle to write next nucleotide.
    center center moveto
    currentBase angle mul rotate
    quarterFont radius rmoveto

    % Determine x and y coordinates of the nucleotide location.
    currentBase angle mul -1 mul rotate
    currentpoint
    /y exch cvi def
    /x exch cvi def
    currentBase angle mul rotate
    quarterFont -1 mul 0 rmoveto

    % Save the nucleotide location and show the nucleotide.
    /point [ x y ] def
    basePoints currentBase point put

    % Set variables for conditions where number labels are found.
    /numCond1 currentBase 1 add 10 mod 0 eq def
    /numCond2 currentBase 1 add 1 eq def
    /numCond3 currentBase 1 add numBases eq def

    % If a condition is met for a number label, write a label.
    numCond1 numCond2 or numCond3 or {
        /Courier-Bold findfont fontSize scalefont setfont
        bases currentBase get show
        halfFont -1 mul labelSpace rmoveto
        /numString 7 string def
        currentBase 1 add numString cvs show
        0 labelSpace -1 mul rmoveto
        /Courier findfont fontSize scalefont setfont
    }
    { bases currentBase get show } ifelse

    % Return to circle center, rotate to 0, increment base.
    0 radius -1 mul rmoveto
    currentBase angle mul -1 mul rotate
    /currentBase currentBase 1 add def
} repeat

% Write the pairing lines inside the backbone.
0 setgray
0 1 numPairings {
    /pair pairings currentPairing get def

    % Determine coordinates of first nucleotide in pair.
    /base1 pair 0 get 1 sub def
    /point1 basePoints base1 get def
    /x1 point1 0 get def
    /y1 point1 1 get def

    % Determine coordinates of second nucleotide in pair.
    /base2 pair 1 get 1 sub def
    /point2 basePoints base2 get def
    /x2 point2 0 get def
    /y2 point2 1 get def

    % If the pair should be colored, set its appropriate color.
    pair 2 get pair 3 get pair 4 get setrgbcolor

    % Draw current pair, then increment current pairing.
    /between base2 base1 sub def
    between numBases 2 div gt { /between numBases between sub def } if

    /midX x1 x2 add 2 div def
    /midY y1 y2 add 2 div def

    /gamma 0.9 def
    /centerThresh radius 2 mul 8 div 5 mul def

    /ends x2 x1 sub x2 x1 sub mul y2 y1 sub y2 y1 sub mul add sqrt def
    /distance between 2 mul numBases div radius mul gamma mul def
    /lineAngle center midY sub center midX sub atan def
    /distX lineAngle cos distance mul 2 mul def
    /distY lineAngle sin distance mul 2 mul def

    /controlX midX distX add def
    /controlY midY distY add def

    ends centerThresh ge {
        /controlX center def
        /controlY center def
    } if

    x1 y1 moveto x1 y1 controlX controlY x2 y2 curveto stroke
    0 setgray
    /currentPairing currentPairing 1 add def
} repeat

% Restore the original scaling to 100%.
grestore

/Courier-Bold findfont fontSize 2 div scalefont setfont

/x1 570 (Accepted:) stringwidth pop sub def
/x2 570 (Pairs: 133) stringwidth pop sub def
/x3 570 (Pseudoknotted Pairs: 7) stringwidth pop sub def
/x4 570 (Sensitivity: 133 / 133 = 100.00%) stringwidth pop sub def
/x5 570 (PPV: 133 / 133 = 100.00%) stringwidth pop sub def

/statistics [
    [(Predicted:) 40 70]
    [(Pairs: 133) 40 55]
    [(Pseudoknotted Pairs: 7) 40 40]
    [(Accepted:) x1 70]
    [(Pairs: 133) x2 55]
    [(Pseudoknotted Pairs: 7) x3 40]
    [(Sensitivity: 133 / 133 = 100.00%) x4 595]
    [(PPV: 133 / 133 = 100.00%) x5 580]
] def

statistics { aload pop moveto show } forall
showpage
